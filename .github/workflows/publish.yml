name: Publish to PyPI

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      publish_to:
        description: 'Where to publish (NOTE: Select a BRANCH, not a tag, to see this dropdown)'
        required: false  # Made optional to handle tag selection
        type: choice
        options:
          - testpypi
          - pypi
        default: 'testpypi'
      # Note: Tag push triggers are disabled to ensure you always choose the destination
      # If you want automatic publishing on tag push, uncomment below and remove the publish_to input
      # push:
      #   tags:
      #     - 'v*'  # Triggers on tags like v0.1.0, v1.0.0, etc.

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for trusted publishing (recommended)

    steps:
    - uses: actions/checkout@v4 

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Determine publish destination
      id: publish_dest
      run: |
        # GitHub UI limitation: inputs don't show when tag is selected
        # If input is provided (branch selected), use it
        if [ -n "${{ github.event.inputs.publish_to }}" ]; then
          PUBLISH_TO="${{ github.event.inputs.publish_to }}"
          echo "‚úÖ Using your selection: $PUBLISH_TO"
        else
          # Input not available (tag selected or not provided)
          # Default to testpypi for safety
          PUBLISH_TO="testpypi"
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "‚ö†Ô∏è  Tag selected: GitHub UI doesn't show the dropdown for tags"
            echo "   Defaulting to 'testpypi' for safety"
            echo ""
            echo "üí° To choose the destination:"
            echo "   1. Select a BRANCH (e.g., 'main') instead of a tag"
            echo "   2. The 'Where to publish' dropdown will appear"
            echo "   3. Choose 'testpypi' or 'pypi'"
            echo ""
            echo "   The version comes from pyproject.toml, not the branch/tag you select."
          else
            echo "‚ö†Ô∏è  No destination specified, defaulting to: $PUBLISH_TO"
          fi
        fi
        echo "publish_to=$PUBLISH_TO" >> $GITHUB_OUTPUT
        echo "üì¶ Publishing to: $PUBLISH_TO"

    - name: Extract version from pyproject.toml
      id: version
      run: |
        # Always extract from pyproject.toml (single source of truth)
        # Python 3.11+ has tomllib built-in, and this workflow uses Python 3.11
        VERSION=$(python3 -c "import tomllib; f=open('pyproject.toml','rb'); d=tomllib.load(f); print(d['project']['version'])")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"
        
        # If triggered from a tag, verify it matches (optional check)
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          if [ "$VERSION" != "$TAG_VERSION" ]; then
            echo "‚ö†Ô∏è  Warning: Tag version ($TAG_VERSION) doesn't match pyproject.toml ($VERSION)"
            echo "The version from pyproject.toml will be used for publishing."
          else
            echo "‚úÖ Tag version matches pyproject.toml"
          fi
        fi

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: Build package
      run: |
        python -m build

    - name: Check package
      run: |
        twine check dist/*

    - name: Publish to TestPyPI
      if: steps.publish_dest.outputs.publish_to == 'testpypi'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
      run: |
        echo "üì¶ Publishing to TestPyPI..."
        twine upload --repository testpypi dist/*
        echo "‚úÖ Published to TestPyPI: https://test.pypi.org/project/mett-dataportal/${{ steps.version.outputs.version }}/"

    - name: Publish to PyPI
      if: steps.publish_dest.outputs.publish_to == 'pypi'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        echo "üì¶ Publishing to PyPI..."
        twine upload dist/*
        echo "‚úÖ Published to PyPI: https://pypi.org/project/mett-dataportal/${{ steps.version.outputs.version }}/"

    - name: Verify publication
      if: always()
      run: |
        PUBLISH_TO="${{ steps.publish_dest.outputs.publish_to }}"
        if [ "$PUBLISH_TO" == "testpypi" ]; then
          echo "‚úÖ Package published successfully to TestPyPI!"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "View at: https://test.pypi.org/project/mett-dataportal/${{ steps.version.outputs.version }}/"
        else
          echo "‚úÖ Package published successfully to PyPI!"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "View at: https://pypi.org/project/mett-dataportal/${{ steps.version.outputs.version }}/"
        fi
